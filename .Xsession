#!/usr/bin/env bash
# Initialize my X session. Different files are used depending on how X is started.
#	$HOME/.Xsession: called by displaymanagers like xdm.
#	$HOME/.xinitrc: called by xinit which is called by startx.
# I want to keep it consistent so I let .xinitrc run this script instead. A symlink would do fine too but those tend to become invalid when moving between systems.

# In case everything goes wrong, we at least fall back to a plain xterm.
failsafe="xterm -ls -T Failsafe -geometry 80x24-0-0"
trap "exec $failsafe" EXIT SIGHUP SIGINT SIGPIPE SIGTERM SIGIO

# Some bash (1 and 2) settings to avoid trouble on a failed program call.
set +e > /dev/null 2>&1
set +u > /dev/null 2>&1
set +o posix  > /dev/null 2>&1
if type shopt > /dev/null 2>&1 ; then
    shopt -s execfail
else
    no_exit_on_failed_exec=1
fi

# Run user xinit scripts.
for script in /etc/X11/xinit/xinitrc.d/*; do
    test -d $script && continue
    test -x $script || continue
    case "$script" in
	.*)		continue ;;
	*.rpm*)		continue ;;
	*.swap)		continue ;;
	*.bak)		continue ;;
	*.orig)		continue ;;
	\#*)		continue ;;
	*~)		continue ;;
    esac
    $script
done
unset script


# Source common code shared between the X session and X init scripts.
. /etc/X11/xinit/xinitrc.common

# Set the right keyboard map.
setxkbmap -layout us -model pc87
#setxkbmap -layout us -model pc105

# Modify key bindings.
if [ -f "$HOME/.Xmodmap" ]; then
	xmodmap $HOME/.Xmodmap
fi

# Updated X resouced database.
if [ -f "$HOME/.Xresources" ]; then
	# Apparently merge will not always work for xterm settings.
	#xrdb -merge $HOME/.Xresources
	xrdb -load $HOME/.Xresources
fi

# Start the window manager with all paramters. This script ends at `exec` below.
unset WINDOW_MANAGER STARTUP
#WINDOWMANAGER='/usr/bin/startkde'
#WINDOWMANAGER='dwm'
#WINDOWMANAGER='ratpoison'
exec $WINDOWMANAGER ${1+"$@"}

# Call failsafe.
exit 0
